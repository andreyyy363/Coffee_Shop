{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Products - KAVASOUL{% endblock %}

{% block content %}
    <h1 class="page-title">Manage Products</h1>


    <!-- Filters -->
    <div class="card p-3 mb-4">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Search</label>
                <input type="text" name="search" class="form-control" value="{{ search }}"
                       placeholder="Product name...">
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select name="active" class="form-select">
                    <option value="">All</option>
                    <option value="1" {% if current_active == '1' %}selected{% endif %}>Active</option>
                    <option value="0" {% if current_active == '0' %}selected{% endif %}>Inactive</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-secondary w-100">Filter</button>
            </div>
        </form>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <!-- Quick Links to Reference Data -->
        <div class="mb-4">
            <span class="me-2">Manage:</span>
            <a href="{% url 'products:manager_countries' %}" class="btn btn-outline-secondary btn-sm">Countries</a>
            <a href="{% url 'products:manager_roast_levels' %}" class="btn btn-outline-secondary btn-sm">Roast
                Levels</a>
            <a href="{% url 'products:manager_bean_types' %}" class="btn btn-outline-secondary btn-sm">Bean Types</a>
            <a href="{% url 'products:manager_weights' %}" class="btn btn-outline-secondary btn-sm">Weights</a>
        </div>
        <a href="{% url 'products:manager_product_create' %}" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Add Product
        </a>
    </div>

    <!-- Products Table -->
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
            <tr>
                <th>Image</th>
                <th>Name</th>
                <th>Price</th>
                <th>Roast</th>
                <th>Countries</th>
                <th>Rating</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for product in products %}
                <tr>
                    <td>
                        {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}"
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                        {% else %}
                            <img src="{% static 'img/default_img.png' %}" alt="{{ product.name }}"
                                 style="width: 50px; height: 50px; object-fit: scale-down; border-radius: 4px;">
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ product.name }}</strong>
                        <br><small class="text-muted">{{ product.slug }}</small>
                    </td>
                    <td>{{ product.base_price }} USD</td>
                    <td>{{ product.roast_level.name|default:"-" }}</td>
                    <td>{{ product.countries_display|default:"-" }}</td>
                    <td>
                        {% if product.average_rating %}
                            <i class="bi bi-star-fill text-warning"></i> {{ product.average_rating|floatformat:1 }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if product.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex gap-1">
                            <a href="{% url 'products:detail' slug=product.slug %}"
                               class="btn btn-sm btn-secondary" title="View" target="_blank">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="{% url 'products:manager_product_edit' pk=product.pk %}"
                               class="btn btn-sm btn-primary" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form method="post" action="{% url 'products:manager_product_toggle' pk=product.pk %}"
                                  class="d-inline">
                                {% csrf_token %}
                                <button type="submit"
                                        class="btn btn-sm btn-{% if product.is_active %}warning{% else %}success{% endif %}"
                                        title="{% if product.is_active %}Deactivate{% else %}Activate{% endif %}">
                                    <i class="bi bi-{% if product.is_active %}pause{% else %}play{% endif %}"></i>
                                </button>
                            </form>
                            <a href="{% url 'products:manager_product_delete' pk=product.pk %}"
                               class="btn btn-sm btn-danger" title="Delete">
                                <i class="bi bi-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="8" class="text-center text-muted py-4">No products found.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if products.has_other_pages %}
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                {% if products.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ products.previous_page_number }}&search={{ search }}&active={{ current_active }}">
                            Previous
                        </a>
                    </li>
                {% endif %}

                {% for num in products.paginator.page_range %}
                    {% if products.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link"
                               href="?page={{ num }}&search={{ search }}&active={{ current_active }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if products.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ products.next_page_number }}&search={{ search }}&active={{ current_active }}">
                            Next
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    {% endif %}
{% endblock %}
